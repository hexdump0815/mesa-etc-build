# get latest xorg server (just as an example) - better build one yourself - see below
apt install --install-recommends xserver-xorg-hwe-18.04
apt-get remove linux-image-5.0.0-37-generic
# undo the above:
apt-get remove devio flash-kernel libunwind8 linux-generic-hwe-18.04 linux-headers-5.0.0-23 linux-headers-5.0.0-23-generic linux-headers-generic-hwe-18.04 linux-image-5.0.0-23-generic linux-image-generic-hwe-18.04 linux-modules-5.0.0-23-generic mtd-utils xserver-xorg-core-hwe-18.04 xserver-xorg-hwe-18.04 xserver-xorg-input-all-hwe-18.04 xserver-xorg-input-libinput-hwe-18.04 xserver-xorg-legacy-hwe-18.04 xserver-xorg-video-all-hwe-18.04 xserver-xorg-video-amdgpu-hwe-18.04 xserver-xorg-video-ati-hwe-18.04 xserver-xorg-video-fbdev-hwe-18.04 xserver-xorg-video-nouveau-hwe-18.04 xserver-xorg-video-radeon-hwe-18.04 xserver-xorg-video-vesa-hwe-18.04
apt-get install xorg-dev xserver-xorg xserver-xorg-core xserver-xorg-dev xserver-xorg-input-all xserver-xorg-input-libinput xserver-xorg-input-synaptics xserver-xorg-input-void xserver-xorg-input-wacom xserver-xorg-legacy xserver-xorg-video-all xserver-xorg-video-amdgpu xserver-xorg-video-ati xserver-xorg-video-dummy xserver-xorg-video-fbdev xserver-xorg-video-nouveau xserver-xorg-video-radeon xserver-xorg-video-vesa
apt-get install xpra # if it was installed before
apt-get remove xorg-video-ati xserver-xorg-video-radeon xserver-xorg-video-vesa # not needed on arm

# kmscude for offline render test - see: https://gitlab.freedesktop.org/lima/web
git clone https://github.com/yuq/kmscube
apt-get install autoconf automake libgbm-dev libegl1-mesa-dev libgles2-mesa-dev libpng-dev
./autogen.sh 
make
export LD_LIBRARY_PATH=/opt/mesa/lib/abc
./kmscube -d -D /dev/dri/renderD129
./kmscube -d -D /dev/dri/renderD129 -M rgba

# build xorg server
apt-get -y install libpixman-1-dev libxkbfile-dev libxfont-dev libgl1-mesa-dev libepoxy-dev libpciaccess-dev libudev-dev libxcb-xinput-dev libxcb-damage0-dev libegl1-mesa-dev ninja-build xfonts-utils libssl-dev
# this is for the input driver symlink hack later ...
apt-get -y install xserver-xorg-input-multitouch xserver-xorg-input-wacom xserver-xorg-input-xwiimote xserver-xorg-input-all xserver-xorg-input-aiptek xserver-xorg-input-elographics xserver-xorg-input-evdev xserver-xorg-input-evdev-dev xserver-xorg-input-joystick xserver-xorg-input-joystick-dev xserver-xorg-input-kbd xserver-xorg-input-libinput xserver-xorg-input-libinput-dev xserver-xorg-input-mouse xserver-xorg-input-mutouch xserver-xorg-input-synaptics xserver-xorg-input-synaptics-dev
git clone https://gitlab.freedesktop.org/xorg/xserver.git
# we need a newer meson than what comes with ubuntu 18.04 to build the xorg server
git clone https://github.com/mesonbuild/meson.git
cd xserver
# maybe later ...
#git checkout xorg-server-21.1.1
# for now as otherwise it will not compile properly ...
git checkout 7e142cb2a848acb6af986fa91d254d4c23963b24
mkdir build
cd build
# for debian bullseye simply use "meson" instead of "python3 ../../meson/meson.py"
# as the default one is new enough - otherwise it might give trouble due to version mismatches
# python3 ../../meson/meson.py .. . --prefix=/opt/xserver --pkg-config-path=/opt/mesa/lib/arm-linux-gnueabihf/pkgconfig:/usr/lib/pkgconfig -Dxorg=true -Dglamor=true -Dxkb_bin_dir=/usr/bin
# python3 ../../meson/meson.py .. . --prefix=/opt/xserver --pkg-config-path=/opt/mesa/lib/aarch64-linux-gnu/pkgconfig:/usr/lib/pkgconfig -Dxorg=true -Dglamor=true -Dxkb_bin_dir=/usr/bin
# build
ninja [-j4]
# install
ninja install
cd /opt/xserver
ln -s /etc etc
ln -s /var var
( cd lib/arm-linux-gnueabihf/xorg/modules/input ; for i in /usr/lib/xorg/modules/input/* ; do ln -s $i ; done )
( cd lib/aarch64-linux-gnu/xorg/modules/input ; for i in /usr/lib/xorg/modules/input/* ; do ln -s $i ; done )
# to use that Xorg instead of the default ubuntu one for instance for lightdm
# mv /usr/lib/xorg/Xorg /usr/lib/xorg/Xorg.org
# ln -s /opt/xserver/bin/Xorg /usr/lib/xorg/Xorg
# apt-mark hold xserver-xorg-core
# to make the keyboard working with this new xorg server on a nyanbig chromebook it had to do
# check with "cat /sys/class/input/event*/device/name" which event number is the proper one below for the kbd
# for chromebooks it will be cros_ec, otherwise something which sounds like a keyboard
# for usb devices matching can be done on usb id
# cat /etc/X11/xorg.conf.d/01-modesetting.conf
Section "InputClass"
	Identifier	"chromebook kbd"
	MatchDevicePath	"/dev/input/event1"
	MatchIsKeyboard	"on"
	Driver		"libinput"
EndSection

Section "InputClass"
	Identifier	"chromebook usb mouse"
	MatchDevicePath	"/dev/input/event*"
	MatchUSBID	"046d:c05a"
	MatchIsPointer	"on"
	Driver		"libinput"
EndSection

Section "InputClass"
	Identifier	"chromebook usb kbd"
	MatchDevicePath	"/dev/input/event*"
	MatchUSBID	"258a:0001"
	MatchIsKeyboard	"on"
	Driver		"libinput"
EndSection

# build libdrm
git clone https://gitlab.freedesktop.org/mesa/drm
# we need a newer meson than what comes with ubuntu 18.04 to build libdrm
git clone https://github.com/mesonbuild/meson.git
cd drm/
mkdir build
cd build
# python3 ../../meson/meson.py .. . -Dnouveau=true -Dfreedreno=true -Dtegra=true -Detnaviv=true -Dexynos=true -Dintel=false -Dradeon=false -Damdgpu=false -Dvmwgfx=false -Domap=false -Dlibkms=false --prefix=/opt/libdrm
ninja -j4
ninja install

# build libdrm-rockchip
git clone https://github.com/rockchip-linux/libdrm-rockchip.git
cd libdrm-rockchip
autoreconf -fvi
# ./configure --enable-rockchip-experimental-api --disable-libkms --disable-intel --disable-radeon --disable-amdgpu --disable-nouveau --disable-vmwgfx --disable-freedreno --disable-vc4 --prefix=/opt/libdrm-rockchip
make
make install
